<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Flex Generator + Admin + Check UserId</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body { font-family: sans-serif; background: #111; color: #fff; text-align: center; padding-top: 40px; }
input { width: 90%; padding: 12px; border-radius: 6px; border: none; font-size: 16px; margin-top: 10px; }
button { font-size: 18px; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; margin-top: 14px; }
.admin-panel { background: rgba(0,0,0,0.6); margin-top: 40px; padding: 20px; border-radius: 10px; white-space: pre-line; }
#checkResult, #myUserId { margin-top: 10px; font-weight: bold; }
</style>
</head>

<body>

<h2>Flex Generator</h2>
<input id="genInput" placeholder="‡∏ß‡∏≤‡∏á: ImageURL + ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ + LINE ID" />
<button onclick="sendFlex()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏£‡πå Flex</button>

<h3>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö UserId</h3>
<input id="checkUserIdInput" placeholder="‡πÉ‡∏™‡πà UserId ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" />
<button onclick="checkUserId()">‡πÄ‡∏ä‡πá‡∏Ñ UserId</button>
<div id="checkResult"></div>

<h3>‡πÇ‡∏ä‡∏ß‡πå UserId ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</h3>
<button onclick="showMyUserId()">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π UserId ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</button>
<div id="myUserId"></div>

<button onclick="requestWhitelist()">‡∏Ç‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° Whitelist (‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</button>

<div class="admin-panel">
  <h3>Admin Panel</h3>
  <input id="wlName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ LINE" />
  <input id="wlUserId" placeholder="userId LINE" />
  <button onclick="addWhitelist()">‡πÄ‡∏û‡∏¥‡πà‡∏° Whitelist</button>
  <button onclick="removeWhitelist()">‡∏•‡∏ö Whitelist</button>

  <h4>Whitelist ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h4>
  <div id="list"></div>
</div>

<script>
const ADMIN = "Uxxxxxxxxxxxxxxxxxxxxxxxx"; // ‚Üê ‡πÉ‡∏™‡πà userId ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
let whitelist = JSON.parse(localStorage.getItem("whitelist") || "[]");
let currentUserId = "";

function renderList() {
  const view = whitelist.map(w => `üë§ ${w.name}\nüÜî ${w.userId}`).join("\n\n");
  document.getElementById("list").innerText = view || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ whitelist";
}

function addWhitelist() {
  if (currentUserId !== ADMIN) return alert("‚õî ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ");
  const name = document.getElementById("wlName").value.trim();
  const userId = document.getElementById("wlUserId").value.trim();
  if (!name || !userId) return alert("‚ùå ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞ userId");
  whitelist.push({ name, userId });
  localStorage.setItem("whitelist", JSON.stringify(whitelist));
  renderList();
  alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° whitelist ‡πÅ‡∏•‡πâ‡∏ß");
}

function removeWhitelist() {
  if (currentUserId !== ADMIN) return alert("‚õî ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏•‡∏ö‡πÑ‡∏î‡πâ");
  const name = document.getElementById("wlName").value.trim();
  const userId = document.getElementById("wlUserId").value.trim();
  whitelist = whitelist.filter(w => !(w.name === name && w.userId === userId));
  localStorage.setItem("whitelist", JSON.stringify(whitelist));
  renderList();
  alert("üóë ‡∏•‡∏ö whitelist ‡πÅ‡∏•‡πâ‡∏ß");
}

async function sendFlex() {
  if (!liff.isInClient()) return alert("‚ö† ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE");
  const profile = await liff.getProfile();
  currentUserId = profile.userId;

  const isAllowed = whitelist.some(w => w.userId === currentUserId);
  if (!isAllowed && currentUserId !== ADMIN) return alert("‚õî ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏ä‡∏£‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô");

  const raw = document.getElementById("genInput").value.trim();
  const parts = raw.split(" ");
  if (parts.length !== 2) return alert("‚ùå format ‡∏ú‡∏¥‡∏î");

  const [imageUrl, lineId] = parts;

  const flexMsg = {
    type: "flex",
    altText: "Flex Message",
    contents: {
      type: "carousel",
      contents: [
        {
          type: "bubble",
          size: "giga",
          hero: { type: "image", url: imageUrl, size: "full", aspectRatio: "2:3", aspectMode: "cover", action: { type: "uri", uri: `http://line.me/ti/p/~${lineId}` } },
          footer: { type: "box", layout: "vertical", spacing: "sm", contents: [ { type: "button", style: "primary", height: "sm", action: { type: "uri", label: "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ ‡∏Ñ‡∏•‡∏¥‡∏Å!!!", uri: `http://line.me/ti/p/~${lineId}` } } ], backgroundColor: "#000000" }
        }
      ]
    }
  };

  try { await liff.shareTargetPicker([flexMsg]); alert("‚ú® ‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); }
  catch(e){ alert("‚ùå ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); console.error(e); }
}

function checkUserId() {
  const checkId = document.getElementById("checkUserIdInput").value.trim();
  const found = whitelist.find(w => w.userId === checkId);
  document.getElementById("checkResult").innerText = found ? `‚úÖ ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô whitelist\n‡∏ä‡∏∑‡πà‡∏≠: ${found.name}` : "‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô whitelist";
}

// üîπ ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏ä‡∏ß‡πå userId ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
async function showMyUserId() {
  if (!liff.isInClient()) return alert("‚ö† ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE");
  const profile = await liff.getProfile();
  currentUserId = profile.userId;
  document.getElementById("myUserId").innerText = `üÜî UserId ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: ${currentUserId}`;
}

async function requestWhitelist() {
  if (!liff.isInClient()) return alert("‚ö† ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE");
  const profile = await liff.getProfile();
  currentUserId = profile.userId;

  await fetch("https://YOUR_SERVER_URL/whitelist-request", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(profile)
  });
  alert("üì® ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß!");
}

liff.init({ liffId: "2008621627-1eN2VA2x" }).then(async () => {
  const profile = await liff.getProfile();
  currentUserId = profile.userId;
  renderList();
});
</script>

</body>
</html>