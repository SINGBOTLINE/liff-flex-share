<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Flex Generator + Admin Whitelist</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
  body {
    font-family: sans-serif;
    background: #111;
    color: #fff;
    text-align: center;
    padding-top: 40px;
  }
  input, textarea {
    width: 90%;
    padding: 12px;
    border-radius: 6px;
    border: none;
    font-size: 16px;
    margin-top: 10px;
  }
  button {
    font-size: 18px;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 14px;
  }
  .admin-panel {
    background: rgba(0,0,0,0.6);
    margin-top: 40px;
    padding: 20px;
    border-radius: 10px;
    white-space: pre-line;
  }
</style>
</head>

<body>

<h2>Flex Generator</h2>
<input id="genInput" placeholder="‡∏ß‡∏≤‡∏á: ImageURL + ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ + LINE ID" />
<button onclick="sendFlex()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏£‡πå Flex</button>

<button onclick="requestWhitelist()">‡∏Ç‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° Whitelist (‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°)</button>

<div class="admin-panel">
  <h3>Admin Panel</h3>
  <input id="wlName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ LINE" />
  <input id="wlUserId" placeholder="userId LINE" />
  <button onclick="addWhitelist()">‡πÄ‡∏û‡∏¥‡πà‡∏° Whitelist</button>
  <button onclick="removeWhitelist()">‡∏•‡∏ö Whitelist</button>

  <h4>Whitelist ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h4>
  <div id="list"></div>
</div>

<script>
const ADMIN = "u72d702258991428344e77670bb76f80a"; // Admin userId
let whitelist = JSON.parse(localStorage.getItem("whitelist") || "[]");

function renderList() {
  const view = whitelist.map(w => `üë§ ${w.name}\nüÜî ${w.userId}`).join("\n\n");
  document.getElementById("list").innerText = view || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ whitelist";
}

function addWhitelist() {
  if (window.currentUserId !== ADMIN) {
    alert("‚õî ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ");
    return;
  }
  const name = document.getElementById("wlName").value.trim();
  const userId = document.getElementById("wlUserId").value.trim();
  if (!name || !userId) return alert("‚ùå ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞ userId");

  whitelist.push({ name, userId });
  localStorage.setItem("whitelist", JSON.stringify(whitelist));
  renderList();
  alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° whitelist ‡πÅ‡∏•‡πâ‡∏ß");
}

function removeWhitelist() {
  if (window.currentUserId !== ADMIN) {
    alert("‚õî ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏•‡∏ö‡πÑ‡∏î‡πâ");
    return;
  }
  const name = document.getElementById("wlName").value.trim();
  const userId = document.getElementById("wlUserId").value.trim();
  whitelist = whitelist.filter(w => !(w.name === name && w.userId === userId));
  localStorage.setItem("whitelist", JSON.stringify(whitelist));
  renderList();
  alert("üóë ‡∏•‡∏ö whitelist ‡πÅ‡∏•‡πâ‡∏ß");
}

async function sendFlex() {
  if (!liff.isInClient()) return alert("‚ö† ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE");

  const profile = await liff.getProfile();
  window.currentUserId = profile.userId;

  const isAllowed = whitelist.some(w => w.userId === profile.userId);
  if (!isAllowed && profile.userId !== ADMIN) {
    alert("‚õî ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏ä‡∏£‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô");
    return;
  }

  const raw = document.getElementById("genInput").value.trim();
  const parts = raw.split(" ");
  if (parts.length !== 2) return alert("‚ùå format ‡∏ú‡∏¥‡∏î");

  const [imageUrl, lineId] = parts;

  const flexMsg = {
    type: "flex",
    altText: "Flex Message",
    contents: {
      type: "carousel",
      contents: [
        {
          type: "bubble",
          size: "giga",
          hero: {
            type: "image",
            url: imageUrl,
            size: "full",
            aspectRatio: "2:3",
            aspectMode: "cover",
            action: { type: "uri", uri: `http://line.me/ti/p/~${lineId}` }
          },
          footer: {
            type: "box",
            layout: "vertical",
            spacing: "sm",
            contents: [
              {
                type: "button",
                style: "primary",
                height: "sm",
                action: { type: "uri", label: "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ ‡∏Ñ‡∏•‡∏¥‡∏Å!!!", uri: `http://line.me/ti/p/~${lineId}` }
              }
            ],
            backgroundColor: "#000000"
          }
        }
      ]
    }
  };

  try {
    await liff.shareTargetPicker([flexMsg]);
    alert("‚ú® ‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
  } catch(e) {
    alert("‚ùå ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    console.error(e);
  }
}

async function requestWhitelist() {
  if (!liff.isInClient()) return alert("‚ö† ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE");

  const profile = await liff.getProfile();
  await fetch("https://YOUR_SERVER_URL/whitelist-request", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(profile)
  });
  alert("üì® ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß!");
}

liff.init({ liffId: "2008621627-1eN2VA2x" }).then(() => {
  liff.getProfile().then(p => { window.currentUserId = p.userId; });
  renderList();
});
</script>

</body>
</html>